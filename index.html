

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CelenganKu v2.1.2 (Beta)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #8B5CF6; 
            --primary-dark: #7C3AED;
            --bg-color: #F3F4F6;
            --text-dark: #1F2937;
            --text-grey: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
            --sidebar-width: 280px;
        }

        /* RESET & LOCK BODY SCROLL */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-color); 
            width: 100vw; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            position: fixed; 
        }

        /* --- LAYOUT UTAMA --- */
        .app-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            background: #F8F9FA; 
            position: relative; 
        }

        .sidebar { display: none; }

        .main-area { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            height: 100%;
        }
        
        /* SCROLLABLE AREA */
        .screen-container { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding-bottom: 100px; 
            -webkit-overflow-scrolling: touch; 
        }
        .screen-container::-webkit-scrollbar { display: none; }

        /* --- HEADER & CARDS --- */
        .purple-header { 
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-dark) 100%); 
            padding: 40px 25px 90px 25px; 
            color: white; 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px; 
            position: relative; 
            z-index: 1; 
            flex-shrink: 0;
        }
        
        .balance-card { 
            background: white; 
            margin: -70px 20px 25px 20px; 
            padding: 25px; 
            border-radius: 24px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
            position: relative; 
            z-index: 2; 
        }
        
        /* TOMBOL MATA BARU (POJOK KANAN) */
        .toggle-privacy-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #1F2937; /* Warna hitam */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .toggle-privacy-btn:active { transform: scale(0.95); }

        .balance-label { font-size: 13px; color: var(--text-grey); font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .balance-amount { font-size: 30px; font-weight: 700; color: var(--text-dark); margin: 12px 0 5px 0; letter-spacing: -0.5px; line-height: 1.2; }
        
        /* LABEL TOTAL HUTANG DI BAWAH SALDO */
        .debt-summary-pill {
            display: inline-block;
            background: #FEF2F2;
            color: var(--danger);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .detail-btn { background: #F3E8FF; color: var(--primary-color); padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-top: 15px; width: fit-content;}

        /* --- MENU GRID --- */
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px; margin-bottom: 30px; }
        .action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .icon-box { width: 55px; height: 55px; background: white; color: var(--primary-color); border-radius: 18px; display: flex; justify-content: center; align-items: center; font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); transition: transform 0.1s; }
        .action-btn:active .icon-box { transform: scale(0.95); }
        .action-label { font-size: 11px; font-weight: 500; color: #555; text-align: center; }

        /* --- ASET & KANTONG STYLE --- */
        .asset-header { padding: 40px 20px 15px 20px; background: white; border-bottom: 1px solid #f0f0f0; }
        .asset-title { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        .pockets-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .pocket-item { padding: 20px; border-radius: 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; position: relative; overflow: hidden; background: white; }
        .pocket-main { background: #F3E8FF; border: 1px solid #E9D5FF; }
        .pocket-main .pocket-icon-small { background: var(--primary-color); color: white; }
        .pocket-regular { background: white; border: 1px solid #F3F4F6; }
        .pocket-regular .pocket-icon-small { background: #F3F4F6; color: var(--text-dark); }
        .pocket-debt { background: #FEF2F2; border: 1px solid #FECACA; }
        .pocket-debt .pocket-icon-small { background: #FEE2E2; color: var(--danger); }
        .debt-badge { font-size: 10px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .pocket-icon-small { width: 45px; height: 45px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 20px; margin-bottom: 15px; }
        .pocket-name-text { font-size: 13px; font-weight: 600; color: var(--text-grey); margin-bottom: 4px; }
        .pocket-bal-text { font-size: 16px; font-weight: 700; color: var(--text-dark); }
        .add-new-pocket { border: 2px dashed #CBD5E1; background: transparent; color: var(--primary-color); display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: none; }

        /* --- DETAIL KANTONG --- */
        .detail-header { padding: 40px 20px 20px 20px; display: flex; align-items: center; gap: 15px; background: white; }
        .detail-content { text-align: center; padding: 40px 20px; background: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .big-pocket-icon { width: 90px; height: 90px; border-radius: 28px; margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; font-size: 45px; color: white; box-shadow: 0 15px 30px rgba(139, 92, 246, 0.2); }
        .detail-pocket-name { font-size: 15px; font-weight: 600; color: var(--text-grey); margin-bottom: 5px; }
        .detail-pocket-bal { font-size: 32px; font-weight: 700; color: var(--text-dark); margin-bottom: 30px; letter-spacing: -0.5px; line-height: 1.2; }
        .debt-split-display { display: flex; justify-content: center; align-items: baseline; gap: 5px; color: var(--text-dark); font-weight: 700; font-size: 24px; margin-bottom: 30px;}
        .debt-current { color: var(--text-dark); }
        .debt-target { color: #9CA3AF; font-size: 20px; }
        .detail-actions { display: flex; justify-content: center; gap: 30px; margin-top: 30px; flex-wrap: wrap; }
        .detail-action-btn { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; min-width: 60px; }
        .detail-icon-circle { width: 55px; height: 55px; border-radius: 50%; background: #F8F9FA; display: flex; justify-content: center; align-items: center; font-size: 22px; color: var(--primary-color); border: 1px solid #eee; }

        /* --- UTILS --- */
        .section-title { padding: 0 25px; margin-bottom: 15px; font-weight: 700; color: var(--text-dark); font-size: 16px; }
        .info-card { background: white; margin: 20px; padding: 25px; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-grey); margin-bottom: 5px; font-weight: 500;}
        .form-input, .form-select { width: 100%; padding: 16px; border: 1px solid #eee; border-radius: 14px; outline: none; background: #F9FAFB; font-size: 15px; }
        .btn-save { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; font-size: 15px; }
        .btn-outline { background: white; color: var(--text-grey); border: 1px solid #ddd; }
        .btn-danger { background: var(--danger); color: white; }
        .password-wrapper { position: relative; width: 100%; }
        .password-toggle-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9CA3AF; cursor: pointer; font-size: 18px; }
        .radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .radio-option { flex: 1; padding: 10px; border: 1px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-size: 13px; color: #666; }
        .radio-option.selected { border-color: var(--primary-color); background: #F3E8FF; color: var(--primary-color); font-weight: 600; }

        /* --- BOTTOM NAV (FIXED) --- */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; left: 0; width: 100%; height: 80px; 
            background: white; 
            display: flex; justify-content: space-around; align-items: center; 
            border-top: 1px solid #eee; 
            z-index: 9999; 
            padding-bottom: 10px; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #9CA3AF; cursor: pointer; flex: 1; -webkit-tap-highlight-color: transparent; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 22px; pointer-events: none; }
        .nav-item span { font-size: 11px; font-weight: 600; pointer-events: none; }

        /* --- DESKTOP --- */
        @media (min-width: 1024px) {
            .app-container { flex-direction: row; }
            .sidebar { display: flex; width: var(--sidebar-width); background: white; flex-direction: column; padding: 40px 30px; border-right: 1px solid #eee; }
            .sidebar-logo { font-size: 26px; font-weight: 700; color: var(--primary-color); margin-bottom: 60px; display: flex; align-items: center; gap: 10px; }
            .sidebar-item { padding: 15px; margin-bottom: 10px; border-radius: 12px; color: var(--text-grey); cursor: pointer; transition: 0.2s; font-weight: 500; display: flex; gap: 15px; align-items: center; font-size: 15px; }
            .sidebar-item:hover, .sidebar-item.active { background-color: #F3E8FF; color: var(--primary-color); }
            .main-area { background-color: #F3F4F6; }
            .screen-container { padding: 40px; max-width: 1200px; margin: 0 auto; width: 100%; padding-bottom: 40px; }
            .purple-header { background: transparent; padding: 0 0 30px 0; color: var(--text-dark); border-radius: 0; display: flex; justify-content: space-between; }
            .balance-card { margin: 0 0 40px 0; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
            .menu-grid { grid-template-columns: repeat(6, 1fr); gap: 20px; padding: 0; }
            .pockets-grid { grid-template-columns: repeat(4, 1fr); padding: 0; }
            .bottom-nav { display: none !important; }
            .mobile-logout-btn { display: none; }
            .modal { align-items: center; } .modal-content { width: 450px; border-radius: 25px; }
        }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; display: none; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; padding: 30px; border-radius: 25px 25px 0 0; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* VISIBILITY */
        .screen { display: none; animation: fadeIn 0.2s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH & OOBE */
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); z-index: 12000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px;}
        .auth-box { background: white; width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .oobe-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); z-index: 13000; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; text-align: center;}
        .oobe-title { font-size: 28px; font-weight: 700; margin-bottom: 10px; margin-top: 20px; }
        .oobe-desc { font-size: 14px; opacity: 0.9; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-top: 30px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .theme-selector { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap;}
        .theme-circle { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .update-list { text-align: left; font-size: 13px; color: #555; margin-bottom: 20px; padding-left: 20px; }
        .update-list li { margin-bottom: 10px; }
        .auth-links { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; font-size: 13px; color: var(--text-grey); }
        .auth-links span { cursor: pointer; }
    </style>
</head>
<body>

<div class="bottom-nav">
    <div class="nav-item active nav-home" onclick="showPage('homeScreen')">
        <i class="fas fa-home"></i><span>Home</span>
    </div>
    <div class="nav-item nav-asset" onclick="showPage('assetScreen')">
        <i class="fas fa-wallet"></i><span>Aset</span>
    </div>
    <div class="nav-item nav-history" onclick="showPage('historyScreen')">
        <i class="fas fa-list-ul"></i><span>Riwayat</span>
    </div>
    <div class="nav-item nav-account" onclick="showPage('accountInfoScreen')">
        <i class="fas fa-user-circle"></i><span>Akun</span>
    </div>
</div>

<div id="oobeScreen" class="oobe-screen">
    <i class="fas fa-piggy-bank" style="font-size: 70px;"></i>
    <h2 class="oobe-title" id="oobeTitle">CelenganKu v2.1.2</h2>
    <p class="oobe-desc" id="oobeDesc">Memuat aplikasi...</p>
    <div class="loader"></div>
</div>

<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <i class="fas fa-piggy-bank" style="font-size: 50px; color: var(--primary-color); margin-bottom: 20px;"></i>
        <h2 id="authTitle" style="margin-bottom: 10px; font-weight: 700;">Selamat Datang</h2>
        <p id="authDesc" style="color: var(--text-grey); margin-bottom: 30px; font-size: 14px;">Kelola keuanganmu dengan lebih pintar.</p>
        
        <input type="text" id="username" class="form-input" placeholder="Username" style="margin-bottom: 15px;">
        <div class="password-wrapper" style="margin-bottom: 20px;">
            <input type="password" id="password" class="form-input" placeholder="Password">
            <i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('password', this)"></i>
        </div>
        
        <button class="btn-save" onclick="handleAuth()" id="authBtn">Masuk</button>
        <button class="btn-save btn-outline" onclick="switchAuthMode('login')" id="cancelAuthBtn" style="display:none; margin-top: 10px;">Batal</button>
        
        <div class="auth-links" id="authLinks">
            <span onclick="switchAuthMode('forgot')" style="text-decoration: underline;">Lupa Password?</span>
            <span onclick="switchAuthMode('register')">Belum punya akun? <b style="color:var(--primary-color)">Daftar</b></span>
        </div>

        <div id="restoreContainer" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <button class="btn-save btn-outline" onclick="triggerRestore()">
                <i class="fas fa-cloud-upload-alt"></i> Restore Data (Pindah HP)
            </button>
            <input type="file" id="restoreInput" style="display: none;" accept=".json" onchange="importData(this)">
        </div>
    </div>
</div>

<div class="app-container">
    <nav class="sidebar">
        <div class="sidebar-logo"><i class="fas fa-piggy-bank"></i> CelenganKu.</div>
        <div class="sidebar-item active" onclick="showPage('homeScreen')"><i class="fas fa-home"></i> Dashboard</div>
        <div class="sidebar-item" onclick="showPage('assetScreen')"><i class="fas fa-wallet"></i> Aset & Kantong</div>
        <div class="sidebar-item" onclick="showPage('historyScreen')"><i class="fas fa-list-ul"></i> Riwayat</div>
        <div class="sidebar-item" onclick="showPage('analysisScreen')"><i class="fas fa-chart-pie"></i> Analisis</div>
        <div class="sidebar-item" onclick="showPage('accountInfoScreen')"><i class="fas fa-user-shield"></i> Akun Saya</div>
        <div class="sidebar-item" style="color: var(--danger); margin-top: auto;" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Keluar</div>
    </nav>

    <main class="main-area">
        <div class="screen-container">
            
            <div id="homeScreen" class="screen active">
                <div class="purple-header">
                    <div>
                        <div style="font-weight: 700; font-size: 22px;"><i class="fas fa-piggy-bank"></i> CelenganKu.</div>
                        <div style="font-size: 14px; opacity: 0.9;">Hai, <span id="userDisplay">User</span></div>
                    </div>
                    <i class="fas fa-sign-out-alt mobile-logout-btn" onclick="logout()" style="font-size: 24px; cursor: pointer;"></i>
                </div>
                
                <div class="balance-card">
                    <div class="toggle-privacy-btn" onclick="toggleBalanceVisibility()">
                        <i class="fas fa-eye" id="toggleIconMain"></i>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="balance-label">
                             <span>Tabungan Utama</span>
                        </div>
                    </div>
                    
                    <div class="balance-amount" id="homeMainBalance">Rp 0</div>
                    
                    <div class="debt-summary-pill" id="homeDebtSummary" style="display:none;">
                        Sisa Tagihan: Rp 0
                    </div>

                    <div class="detail-btn" onclick="openMainPocketDetail()">Detail <i class="fas fa-chevron-right" style="font-size: 10px;"></i></div>
                </div>

                <div class="section-title">Menu Transaksi</div>
                <div class="menu-grid">
                    <div class="action-btn" onclick="openModal('in')"><div class="icon-box"><i class="fas fa-plus-square"></i></div><span class="action-label">Isi Saldo</span></div>
                    <div class="action-btn" onclick="openModal('out')"><div class="icon-box"><i class="fas fa-arrow-up"></i></div><span class="action-label">Pengeluaran</span></div>
                    <div class="action-btn" onclick="showPage('historyScreen')"><div class="icon-box"><i class="fas fa-history"></i></div><span class="action-label">Riwayat</span></div>
                    <div class="action-btn" onclick="showPage('analysisScreen')"><div class="icon-box" style="color:#F59E0B;"><i class="fas fa-chart-pie"></i></div><span class="action-label">Analisis</span></div>
                    <div class="action-btn" onclick="showUpdateNotes()"><div class="icon-box" style="color:#10B981;"><i class="fas fa-bullhorn"></i></div><span class="action-label">Info Update</span></div>
                    <div class="action-btn" onclick="openDonation()"><div class="icon-box" style="color:#EC4899;"><i class="fas fa-hand-holding-heart"></i></div><span class="action-label">Donasi</span></div>
                </div>
                
                <div class="info-card" style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; background: #E0F2FE; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #0284C7; font-size: 20px;"><i class="fas fa-lightbulb"></i></div>
                    <div><h4 style="font-size: 14px; margin-bottom: 3px;">Tips Keuangan</h4><p style="font-size: 12px; color: var(--text-grey);">Pisahkan uang jajan dan tabunganmu menggunakan fitur <b>Kantong</b> di menu Aset.</p></div>
                </div>
            </div>

            <div id="assetScreen" class="screen">
                <div class="asset-header"><div class="asset-title">Aset Saya</div></div>
                <div class="asset-summary-card" style="background: white; margin: 20px; padding: 25px; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                    <div class="balance-label">Total Seluruh Aset</div>
                    <div class="balance-amount" id="assetTotalBalance">Rp 0</div>
                    <div style="font-size: 11px; color: var(--text-grey); margin-top:5px;">*Kantong Hutang tidak dihitung</div>
                </div>
                <div class="section-title">Daftar Kantong</div>
                <div class="pockets-grid" id="pocketGrid"></div>
            </div>

            <div id="pocketDetailScreen" class="screen" style="background: white; min-height: 100%;">
                <div class="detail-header"><i class="fas fa-arrow-left back-btn" onclick="goBackToPrevious()"></i><span style="font-weight: 700; font-size: 18px;">Rincian Kantong</span></div>
                <div class="detail-content">
                    <div class="big-pocket-icon" id="detailIconBox"><i class="fas fa-wallet" id="detailIcon"></i></div>
                    <div class="detail-pocket-name" id="detailName">Nama Kantong</div>
                    <div id="detailBalanceContainer"><div class="detail-pocket-bal" id="detailBalance">Rp 0</div></div>
                    <div class="detail-actions">
                        <div class="detail-action-btn" onclick="openModal('in', currentPocketId)"><div class="detail-icon-circle"><i class="fas fa-plus"></i></div><span class="detail-action-label">Tambah</span></div>
                        <div class="detail-action-btn" onclick="openModal('out', currentPocketId)"><div class="detail-icon-circle" style="color: var(--danger); border-color: var(--danger);"><i class="fas fa-arrow-up"></i></div><span class="detail-action-label">Pakai</span></div>
                        <div class="detail-action-btn" onclick="deleteCurrentPocket()"><div class="detail-icon-circle" style="color: var(--text-grey);"><i class="fas fa-trash-alt"></i></div><span class="detail-action-label">Hapus</span></div>
                        <div class="detail-action-btn" id="editDebtBtn" style="display:none;" onclick="editDebtTarget()"><div class="detail-icon-circle" style="color: #F59E0B;"><i class="fas fa-pen"></i></div><span class="detail-action-label">Target</span></div>
                    </div>
                </div>
                <div style="height: 10px; background: #F8F9FA;"></div>
                <div style="padding: 25px;">
                    <h4 style="font-size: 16px; margin-bottom: 20px; font-weight: 700;">Riwayat Transaksi</h4>
                    <p style="font-size:11px; color:#888; margin-bottom:10px;">Klik transaksi untuk Edit/Hapus</p>
                    <ul id="pocketHistoryList" style="list-style: none;"></ul>
                </div>
            </div>

            <div id="historyScreen" class="screen">
                <div class="section-title" style="margin-top: 25px;">Semua Riwayat</div>
                <div class="info-card"><ul id="globalTransactionList" style="list-style: none;"></ul></div>
            </div>

            <div id="analysisScreen" class="screen">
                <div class="section-title" style="margin-top: 25px;">Analisis Keuangan</div>
                <div class="info-card" style="text-align: center;">
                    <canvas id="financeChart"></canvas>
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <div style="flex:1; background:#ECFDF5; padding:15px; border-radius:15px;"><small style="color:#065F46">Pemasukan</small><br><b style="color:#059669; font-size:16px;" id="totalInDisplay">Rp 0</b></div>
                        <div style="flex:1; background:#FEF2F2; padding:15px; border-radius:15px;"><small style="color:#991B1B">Pengeluaran</small><br><b style="color:#DC2626; font-size:16px;" id="totalOutDisplay">Rp 0</b></div>
                    </div>
                </div>
            </div>

            <div id="accountInfoScreen" class="screen">
                <div class="section-title" style="margin-top: 25px;">Profil & Pengaturan</div>
                <div class="info-card"><h4 style="margin-bottom:15px; font-size:15px;">Data Backup</h4><button class="btn-save" onclick="exportData()"><i class="fas fa-download"></i> Simpan Data ke File</button></div>
                <div class="info-card">
                    <h4 style="margin-bottom:15px; font-size:15px;">Ganti Password</h4>
                    <div class="form-group"><label>Password Lama</label><div class="password-wrapper"><input type="password" id="oldPass" class="form-input"><i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('oldPass', this)"></i></div></div>
                    <div class="form-group"><label>Password Baru</label><div class="password-wrapper"><input type="password" id="newPass" class="form-input"><i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('newPass', this)"></i></div></div>
                    <button class="btn-save" onclick="changePassword()">Simpan Password Baru</button>
                </div>
                <div class="info-card"><h4 style="margin-bottom:15px; font-size:15px;">Personalisasi</h4><div class="theme-selector"><div class="theme-circle" style="background:#8B5CF6" onclick="setTheme('#8B5CF6', '#7C3AED')"></div><div class="theme-circle" style="background:#3B82F6" onclick="setTheme('#3B82F6', '#2563EB')"></div><div class="theme-circle" style="background:#10B981" onclick="setTheme('#10B981', '#059669')"></div><div class="theme-circle" style="background:#EC4899" onclick="setTheme('#EC4899', '#DB2777')"></div><div class="theme-circle" style="background:#1F2937" onclick="setTheme('#1F2937', '#111827')"></div></div></div>
                <div class="info-card"><h4 style="margin-bottom:15px; font-size:15px; color:var(--danger);">Zona Bahaya</h4><button class="btn-save btn-danger" onclick="resetBalance()">Reset Semua Data</button></div>
                <div style="text-align: center; margin-bottom: 30px;"><button class="btn-save btn-outline" style="border: none; color: var(--text-grey);" onclick="logout()">Keluar Aplikasi</button></div>
            </div>
        </div>
    </main>
</div>

<div id="transactionModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="text-align:center; margin-bottom:20px;">Transaksi</h3>
        <div class="form-group"><label>Pilih Kantong</label><select id="pocketSelect" class="form-select"></select></div>
        <input type="tel" id="amountInput" class="form-input" style="font-size: 24px; text-align: center;" placeholder="Rp 0" oninput="formatInputRupiah(this)">
        <button class="btn-save" onclick="processTransaction()">Konfirmasi</button>
        <button class="btn-save btn-outline" style="margin-top: 10px; border:none;" onclick="document.getElementById('transactionModal').style.display='none'">Batal</button>
    </div>
</div>

<div id="transactionActionModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; margin-bottom:15px;">Aksi Transaksi</h3>
        <p style="text-align:center; color:#666; margin-bottom:20px; font-size:13px;">Pilih tindakan untuk riwayat ini</p>
        <div style="display:flex; gap:10px;"><button class="btn-save" onclick="editSelectedTransaction()">Edit Nominal</button><button class="btn-save btn-danger" onclick="deleteSelectedTransaction()">Hapus</button></div>
        <button class="btn-save btn-outline" style="margin-top: 10px; border:none;" onclick="document.getElementById('transactionActionModal').style.display='none'">Batal</button>
    </div>
</div>

<div id="addPocketModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; margin-bottom:20px;">Kantong Baru</h3>
        <div class="radio-group"><div class="radio-option selected" id="optRegular" onclick="selectPocketType('regular')">Tabungan</div><div class="radio-option" id="optDebt" onclick="selectPocketType('debt')">Hutang/Cicilan</div></div>
        <input type="text" id="newPocketName" class="form-input" placeholder="Nama Kantong" style="margin-bottom: 15px;">
        <input type="tel" id="newPocketTarget" class="form-input" placeholder="Total Hutang (Rp)" style="margin-bottom: 15px; display:none;" oninput="formatInputRupiah(this)">
        <div class="form-group"><label>Pilih Ikon</label><div class="theme-selector"><div class="theme-circle" style="background:#8B5CF6" onclick="selectPocketIcon('fa-wallet', '#8B5CF6')"></div><div class="theme-circle" style="background:#10B981" onclick="selectPocketIcon('fa-utensils', '#10B981')"></div><div class="theme-circle" style="background:#F59E0B" onclick="selectPocketIcon('fa-gamepad', '#F59E0B')"></div><div class="theme-circle" style="background:#EF4444" onclick="selectPocketIcon('fa-heart', '#EF4444')"></div><div class="theme-circle" style="background:#3B82F6" onclick="selectPocketIcon('fa-plane', '#3B82F6')"></div></div></div>
        <button class="btn-save" onclick="createNewPocket()">Buat</button>
        <button class="btn-save btn-outline" style="margin-top: 10px; border:none;" onclick="document.getElementById('addPocketModal').style.display='none'">Batal</button>
    </div>
</div>

<div id="updateNotesModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; margin-bottom:20px;">Update v2.1.2 (Beta)</h3>
        <div style="margin-bottom:15px; font-size:14px; color:#333; font-weight:600;">Update CelenganKu v2.1.2 (Beta) is here!</div>
        <ul class="update-list">
            <li><i class="fas fa-check-circle" style="color:var(--success)"></i> <b>Fitur Hutang:</b> Total hutang & sisa tagihan terlihat jelas di depan.</li>
            <li><i class="fas fa-magic" style="color:var(--primary-color)"></i> <b>Auto-Clean:</b> Hutang lunas otomatis hilang.</li>
            <li><i class="fas fa-eye" style="color:var(--primary-color)"></i> <b>UI Update:</b> Tampilan tombol hide balance baru.</li>
            <li><i class="fas fa-wrench" style="color:var(--danger)"></i> <b>Fix Navigasi:</b> Tombol Back aman (tidak keluar Chrome).</li>
        </ul>
        <p style="text-align:center; font-size:12px; color:#666; margin-top:10px;">Kalau ada kendala lapor ya, Makasih!</p>
        <button class="btn-save" onclick="document.getElementById('updateNotesModal').style.display='none'">Tutup</button>
    </div>
</div>

<script>
    let currentUser = null;
    let users = [];
    try { users = JSON.parse(localStorage.getItem('celengan_users_v4')) || []; } catch(e) { users=[]; }
    let currentAuthMode = 'login', transactionType = 'in', isBalanceHidden = localStorage.getItem('balance_hidden') === 'true';
    let currentPocketId = null, tempNewPocket = { icon: 'fa-wallet', color: '#8B5CF6', type: 'regular' };
    let selectedTransactionId = null, financeChart = null;

    window.addEventListener('load', () => {
        // --- FIX NAVIGASI (BACK BUTTON) ---
        // Mencegah keluar dari browser saat tekan back
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            // Jika di halaman auth, biarkan user keluar atau tetap (opsional)
            if(document.getElementById('authScreen').style.display !== 'none') {
                // Biarkan default history behavior jika di login screen (atau block jika mau)
            } else {
                // Jika di dalam aplikasi
                if(document.getElementById('pocketDetailScreen').classList.contains('active')) {
                    showPage('assetScreen'); // Balik ke list aset
                    history.pushState(null, null, location.href); // Kunci lagi
                }
                else if(!document.getElementById('homeScreen').classList.contains('active')) {
                    showPage('homeScreen'); // Balik ke home
                    history.pushState(null, null, location.href); // Kunci lagi
                }
                else {
                    // Jika sudah di home, user mungkin mau keluar? 
                    // Kita bisa tahan atau biarkan keluar. 
                    // Uncomment bawah ini kalau mau benar2 maksa stay di app:
                    // history.pushState(null, null, location.href);
                }
            }
        };

        if(users.length === 0 && localStorage.getItem('celengan_users_v3')) {
            try {
                let oldData = JSON.parse(localStorage.getItem('celengan_users_v3'));
                users = oldData.map(u => ({...u, pockets: [{ id: Date.now(), name: "Tabungan Utama", balance: u.balance || 0, icon: "fa-wallet", color: "#8B5CF6" }], transactions: [] }));
                localStorage.setItem('celengan_users_v4', JSON.stringify(users));
            } catch(e) {}
        }
        const savedPrimary = localStorage.getItem('theme_primary');
        const savedDark = localStorage.getItem('theme_dark');
        if(savedPrimary) setTheme(savedPrimary, savedDark);
        showOOBE('startup', '').then(() => { document.getElementById('authScreen').style.display='flex'; checkUpdate(); });
    });

    const formatRupiah = (n) => new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n);
    const formatDate = (s) => new Date(s).toLocaleDateString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});

    function showOOBE(type, name) {
        const oobe = document.getElementById('oobeScreen');
        const title = document.getElementById('oobeTitle');
        const desc = document.getElementById('oobeDesc');
        oobe.style.display = 'flex';
        if(type === 'startup') { title.innerText = "CelenganKu v2.1.2"; desc.innerText = "Memuat aplikasi..."; return new Promise(r => setTimeout(() => { oobe.style.display='none'; r(); }, 2000)); }
        else if(type === 'login') { title.innerText = `Halo, ${name}!`; desc.innerText = "Mempersiapkan akunmu..."; return new Promise(r => setTimeout(() => { oobe.style.display='none'; r(); }, 2000)); }
        else { title.innerText = "Sampai Jumpa!"; desc.innerText = "Terima kasih telah menabung."; return new Promise(r => setTimeout(() => { oobe.style.display='none'; location.reload(); }, 2000)); }
    }

    function handleAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return alert("Isi data!");
        if(currentAuthMode === 'login') {
            const user = users.find(x => x.username === u && x.password === p);
            if(user) { currentUser = user; if(!currentUser.pockets) currentUser.pockets = [{ id: Date.now(), name: "Tabungan Utama", balance: 0, icon: "fa-wallet", color: "#8B5CF6" }]; document.getElementById('authScreen').style.display = 'none'; showOOBE('login', u).then(initApp); } else alert("Salah username/password");
        } else if(currentAuthMode === 'register') {
            if(users.find(x => x.username === u)) return alert("Username ada!");
            users.push({ username:u, password:p, pockets: [{ id: Date.now(), name: "Tabungan Utama", balance: 0, icon: "fa-wallet", color: "#8B5CF6" }], transactions:[] });
            localStorage.setItem('celengan_users_v4', JSON.stringify(users)); alert("Daftar sukses!"); switchAuthMode('login');
        } else if(currentAuthMode === 'forgot') {
            const user = users.find(x => x.username === u);
            if(user) { user.password = p; localStorage.setItem('celengan_users_v4', JSON.stringify(users)); alert("Password direset!"); switchAuthMode('login'); } else alert("Username tidak ada!");
        }
    }

    function switchAuthMode(mode) {
        currentAuthMode = mode;
        const title=document.getElementById('authTitle'), desc=document.getElementById('authDesc'), btn=document.getElementById('authBtn'), links=document.getElementById('authLinks'), cancel=document.getElementById('cancelAuthBtn'), restore=document.getElementById('restoreContainer'), pass=document.getElementById('password');
        document.getElementById('username').value = ''; pass.value = '';
        if(mode==='register'){ title.innerText='Buat Akun'; desc.innerText='Daftar baru'; btn.innerText='Daftar'; links.innerHTML=`<span onclick="switchAuthMode('login')">Sudah punya? <b style="color:var(--primary-color)">Masuk</b></span>`; cancel.style.display='none'; restore.style.display='block'; pass.placeholder="Buat Password"; }
        else if(mode==='forgot'){ title.innerText='Reset Password'; desc.innerText='Reset akun'; btn.innerText='Simpan'; links.style.display='none'; cancel.style.display='block'; restore.style.display='none'; pass.placeholder="Password Baru"; }
        else { title.innerText='Masuk'; desc.innerText='Login akun'; btn.innerText='Masuk'; links.style.display='flex'; links.innerHTML=`<span onclick="switchAuthMode('forgot')" style="text-decoration:underline">Lupa Password?</span><span onclick="switchAuthMode('register')">Belum punya? <b style="color:var(--primary-color)">Daftar</b></span>`; cancel.style.display='none'; restore.style.display='block'; pass.placeholder="Password"; }
    }

    function togglePasswordVisibility(id, icon) { const x=document.getElementById(id); if(x.type==="password"){x.type="text";icon.classList.remove("fa-eye");icon.classList.add("fa-eye-slash");}else{x.type="password";icon.classList.remove("fa-eye-slash");icon.classList.add("fa-eye");} }
    function changePassword(){ const o=document.getElementById('oldPass').value, n=document.getElementById('newPass').value; if(o!==currentUser.password)return alert("Password lama salah"); if(n.length<3)return alert("Pendek!"); currentUser.password=n; updateUI(); document.getElementById('oldPass').value=''; document.getElementById('newPass').value=''; alert("Sukses"); }
    function logout() { if(confirm("Keluar?")) { document.getElementById('authScreen').style.display='flex'; document.getElementById('username').value=''; document.getElementById('password').value=''; } }

    function checkUpdate() { 
        // Ubah key ini supaya popup muncul lagi di user
        if(!localStorage.getItem('update_seen_v2.1.2_beta')) { 
            localStorage.setItem('update_seen_v2.1.2_beta', 'true'); 
            document.getElementById('updateNotesModal').style.display = 'flex'; 
        } 
    }
    function showUpdateNotes() { document.getElementById('updateNotesModal').style.display = 'flex'; }
    function openDonation() { if(confirm("Buka Saweria?")) window.open('https://saweria.co/tetoyapping29312', '_blank'); }

    function initApp() { document.getElementById('userDisplay').innerText = currentUser.username; updateUI(); showPage('homeScreen'); }
    
    // --- UI LOGIC: DEBT CALCULATION ---
    function updateUI() {
        const idx = users.findIndex(u=>u.username===currentUser.username); if(idx!==-1) { users[idx]=currentUser; localStorage.setItem('celengan_users_v4', JSON.stringify(users)); }
        
        const main = currentUser.pockets[0]||{balance:0}; 
        document.getElementById('homeMainBalance').innerText = isBalanceHidden?'Rp ••••••••':formatRupiah(main.balance);
        
        const total = currentUser.pockets.reduce((a,b)=> (b.type!=='debt'?a+b.balance:a),0); 
        document.getElementById('assetTotalBalance').innerText = isBalanceHidden?'Rp ••••••••':formatRupiah(total);
        
        let totalDebt = 0;
        let hasDebt = false;
        currentUser.pockets.forEach(p => {
            if(p.type === 'debt') {
                const remaining = p.target - p.balance;
                if(remaining > 0) totalDebt += remaining;
                hasDebt = true;
            }
        });
        
        const debtSummary = document.getElementById('homeDebtSummary');
        const eyeIcon = document.getElementById('toggleIconMain');

        if(hasDebt && totalDebt > 0) {
            debtSummary.style.display = 'inline-block';
            debtSummary.innerText = isBalanceHidden ? 'Sisa Tagihan: Rp ••••••' : `Sisa Tagihan: ${formatRupiah(totalDebt)}`;
        } else {
            debtSummary.style.display = 'none';
        }

        if(isBalanceHidden) {
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        } else {
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        }

        renderAssetGrid(); 
        if(currentPocketId) loadPocketDetail(currentPocketId);
    }

    // --- ASSET GRID: AUTO HIDE PAID DEBTS ---
    function renderAssetGrid() {
        const grid = document.getElementById('pocketGrid'); grid.innerHTML = '';
        currentUser.pockets.forEach(p => {
            // Logic Auto-Clean: Skip rendering if debt is paid off (balance >= target)
            if (p.type === 'debt' && p.balance >= p.target) {
                return; 
            }

            const isMain=p.name==="Tabungan Utama", isDebt=p.type==='debt';
            let cls = isMain?'pocket-item pocket-main':'pocket-item pocket-regular'; if(isDebt) cls='pocket-item pocket-debt';
            const col = isMain?'white':p.color, bdg = isDebt?'<span class="debt-badge">Hutang</span>':'';
            const el = document.createElement('div'); el.className=cls;
            
            let displayBal = isBalanceHidden?'••••':formatRupiah(p.balance);
            
            el.innerHTML = `<div class="pocket-icon-small" style="color:${col}"><i class="fas ${p.icon}"></i></div><div>${bdg}<div class="pocket-name-text">${p.name}</div><div class="pocket-bal-text">${displayBal}</div></div>`;
            el.onclick = () => { showPage('pocketDetailScreen'); loadPocketDetail(p.id); }; grid.appendChild(el);
        });
        const add = document.createElement('div'); add.className='pocket-item add-new-pocket'; add.innerHTML='<i class="fas fa-plus" style="font-size:24px; margin-bottom:5px;"></i><span style="font-size:12px; font-weight:600;">Buat Baru</span>';
        add.onclick=()=>document.getElementById('addPocketModal').style.display='flex'; grid.appendChild(add);
    }

    function openMainPocketDetail() { if(currentUser.pockets.length>0) { showPage('pocketDetailScreen'); loadPocketDetail(currentUser.pockets[0].id); } }
    function loadPocketDetail(pid) {
        currentPocketId = pid; const pocket = currentUser.pockets.find(p => p.id === pid); if(!pocket) return showPage('assetScreen');
        document.getElementById('detailIconBox').style.backgroundColor = pocket.color; document.getElementById('detailIcon').className = `fas ${pocket.icon}`;
        document.getElementById('detailName').innerText = pocket.name;
        
        const balContainer = document.getElementById('detailBalanceContainer');
        if(pocket.type === 'debt') {
            const target = pocket.target || 0;
            balContainer.innerHTML = `<div class="debt-split-display"><span class="debt-current">${isBalanceHidden?'•••':formatRupiah(pocket.balance)}</span> <span style="font-size:16px; font-weight:400; color:#999;">/</span> <span class="debt-target">${isBalanceHidden?'•••':formatRupiah(target)}</span></div>`;
            document.getElementById('editDebtBtn').style.display = 'flex';
        } else {
            balContainer.innerHTML = `<div class="detail-pocket-bal">${isBalanceHidden?'Rp •••••••':formatRupiah(pocket.balance)}</div>`;
            document.getElementById('editDebtBtn').style.display = 'none';
        }

        const list = document.getElementById('pocketHistoryList'); list.innerHTML = '';
        const pTrans = currentUser.transactions.filter(t => t.pocketId === pid).sort((a,b)=>new Date(b.date)-new Date(a.date));
        if(pTrans.length === 0) list.innerHTML = '<li style="text-align:center; color:#999; font-size:12px;">Belum ada transaksi</li>';
        else pTrans.forEach(t => {
            if(!t.id) t.id = Date.now() + Math.random();
            const item = document.createElement('li'); item.style.cssText="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f0f0f0;font-size:13px;cursor:pointer;";
            item.innerHTML = `<div>${t.desc}<br><span style="font-size:10px;color:#999">${formatDate(t.date)}</span></div><div class="${t.type==='in'?'text-success':'text-danger'}" style="font-weight:600">${t.type==='in'?'+':'-'} ${formatRupiah(t.amount)}</div>`;
            item.onclick=()=>openTransactionAction(t.id); list.appendChild(item);
        });
    }

    function showPage(pid) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(pid).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(pid==='homeScreen') document.querySelector('.nav-home').classList.add('active');
        if(pid==='assetScreen') document.querySelector('.nav-asset').classList.add('active');
        if(pid==='historyScreen') { document.querySelector('.nav-history').classList.add('active'); renderGlobalHistory(); }
        if(pid==='accountInfoScreen') document.querySelector('.nav-account').classList.add('active');
        if(pid==='analysisScreen') renderChart();
    }
    function goBackToPrevious() { showPage('assetScreen'); }

    function openModal(t, pid=null) { transactionType=t; document.getElementById('modalTitle').innerText=t==='in'?'Isi Saldo':'Catat Pengeluaran';
        const sel = document.getElementById('pocketSelect'); sel.innerHTML='';
        currentUser.pockets.forEach(p=>{ 
            if(p.type === 'debt' && p.balance >= p.target) return;
            const o=document.createElement('option'); o.value=p.id; o.text=p.name+` (${formatRupiah(p.balance)})`; sel.appendChild(o); 
        });
        if(pid) sel.value=pid; document.getElementById('transactionModal').style.display='flex'; document.getElementById('amountInput').value=''; 
    }
    
    function processTransaction() {
        const val = parseInt(document.getElementById('amountInput').value.replace(/\./g,'')||0); const pid = parseInt(document.getElementById('pocketSelect').value);
        if(val<=0) return alert("Nominal salah");
        const pocket = currentUser.pockets.find(p=>p.id===pid);
        
        if(transactionType==='out' && val > pocket.balance) return alert("Saldo kurang!");
        
        if(pocket.type === 'debt' && transactionType === 'in') {
            if(pocket.balance >= pocket.target) return alert("Hutang sudah lunas!");
            if(pocket.balance + val > pocket.target) return alert(`Melebihi tagihan! Sisa: ${formatRupiah(pocket.target - pocket.balance)}`);
        }

        pocket.balance += transactionType==='in'?val:-val;
        currentUser.transactions.push({ id:Date.now(), type:transactionType, amount:val, pocketId:pid, date:new Date().toISOString(), desc:transactionType==='in'?'Isi Saldo':'Pengeluaran' });
        updateUI(); document.getElementById('transactionModal').style.display='none';
    }

    function selectPocketType(t) { tempNewPocket.type=t; document.getElementById('optRegular').className=t==='regular'?'radio-option selected':'radio-option'; document.getElementById('optDebt').className=t==='debt'?'radio-option selected':'radio-option'; document.getElementById('newPocketTarget').style.display=t==='debt'?'block':'none'; }
    function selectPocketIcon(i,c) { tempNewPocket.icon=i; tempNewPocket.color=c; }
    function createNewPocket() {
        const n = document.getElementById('newPocketName').value; if(!n) return;
        let tgt = 0; if(tempNewPocket.type==='debt') tgt = parseInt(document.getElementById('newPocketTarget').value.replace(/\./g,'')||0);
        currentUser.pockets.push({ id:Date.now(), name:n, balance:0, icon:tempNewPocket.icon, color:tempNewPocket.color, type:tempNewPocket.type, target:tgt });
        updateUI(); document.getElementById('addPocketModal').style.display='none';
    }
    function deleteCurrentPocket() { if(currentPocketId===currentUser.pockets[0].id) return alert("Utama tidak bisa dihapus"); if(confirm("Hapus?")) { currentUser.pockets=currentUser.pockets.filter(p=>p.id!==currentPocketId); updateUI(); showPage('assetScreen'); } }
    function editDebtTarget() {
        const pocket = currentUser.pockets.find(p=>p.id===currentPocketId);
        const newT = prompt("Masukkan total hutang baru:", pocket.target);
        if(newT) { pocket.target = parseInt(newT.replace(/\./g,'')); updateUI(); }
    }

    function openTransactionAction(id) { selectedTransactionId=id; document.getElementById('transactionActionModal').style.display='flex'; }
    function deleteSelectedTransaction() {
        if(confirm("Hapus transaksi? Saldo dikembalikan.")) {
            const idx = currentUser.transactions.findIndex(t=>t.id===selectedTransactionId); if(idx===-1)return;
            const tx = currentUser.transactions[idx]; const p = currentUser.pockets.find(x=>x.id===tx.pocketId);
            if(p) { if(tx.type==='in') p.balance-=tx.amount; else p.balance+=tx.amount; }
            currentUser.transactions.splice(idx,1); updateUI(); document.getElementById('transactionActionModal').style.display='none';
            if(document.getElementById('pocketDetailScreen').classList.contains('active')) loadPocketDetail(p.id);
            if(document.getElementById('historyScreen').classList.contains('active')) renderGlobalHistory();
        }
    }
    
    function editSelectedTransaction() {
        const idx = currentUser.transactions.findIndex(t=>t.id===selectedTransactionId); if(idx===-1)return;
        const tx = currentUser.transactions[idx]; const p = currentUser.pockets.find(x=>x.id===tx.pocketId);
        const newA = prompt("Nominal baru:", tx.amount); if(!newA)return;
        const val = parseInt(newA); if(isNaN(val)||val<=0)return;
        
        if(p) { 
            let potentialBal = p.balance;
            if(tx.type === 'in') potentialBal -= tx.amount; else potentialBal += tx.amount;
            if(tx.type === 'in') potentialBal += val; else potentialBal -= val;
            if(p.type === 'debt' && tx.type === 'in' && potentialBal > p.target) return alert("Melebihi hutang!");
            if(potentialBal < 0) return alert("Saldo jadi minus!");
            p.balance = potentialBal;
        }
        tx.amount=val; updateUI(); document.getElementById('transactionActionModal').style.display='none';
        if(document.getElementById('pocketDetailScreen').classList.contains('active')) loadPocketDetail(p.id);
        if(document.getElementById('historyScreen').classList.contains('active')) renderGlobalHistory();
    }

    function renderGlobalHistory() { const l=document.getElementById('globalTransactionList'); l.innerHTML=''; const s=[...currentUser.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)); s.forEach(t=>{ if(!t.id)t.id=Date.now()+Math.random(); const pName=currentUser.pockets.find(p=>p.id==t.pocketId)?.name||'x'; const i=document.createElement('li'); i.style.cssText="display:flex;justify-content:space-between;padding:15px;border-bottom:1px solid #f0f0f0;cursor:pointer;"; i.innerHTML=`<div><b>${t.desc}</b> <span style="font-size:10px;background:#f3f4f6;padding:2px 5px;border-radius:4px;">${pName}</span><br><small style="color:#888">${formatDate(t.date)}</small></div><div class="${t.type==='in'?'text-success':'text-danger'}" style="font-weight:600">${t.type==='in'?'+':'-'} ${formatRupiah(t.amount)}</div>`; i.onclick=()=>openTransactionAction(t.id); l.appendChild(i); }); }
    function renderChart() { const i=currentUser.transactions.filter(t=>t.type==='in').reduce((a,b)=>a+b.amount,0), o=currentUser.transactions.filter(t=>t.type==='out').reduce((a,b)=>a+b.amount,0); document.getElementById('totalInDisplay').innerText=formatRupiah(i); document.getElementById('totalOutDisplay').innerText=formatRupiah(o); if(financeChart)financeChart.destroy(); financeChart=new Chart(document.getElementById('financeChart').getContext('2d'),{type:'doughnut',data:{labels:['Masuk','Keluar'],datasets:[{data:(i==0&&o==0)?[1]:[i,o],backgroundColor:(i==0&&o==0)?['#eee']:['#10B981','#EF4444'],borderWidth:0}]}}); }
    
    function triggerRestore(){ document.getElementById('restoreInput').click(); }
    function importData(i){ const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(Array.isArray(d)&&d[0].username && confirm("Timpa data?")){ localStorage.setItem('celengan_users_v4',JSON.stringify(d)); alert("Sukses!"); location.reload(); } }catch(e){ alert("File rusak"); } }; r.readAsText(i.files[0]); }
    function exportData(){ const s=JSON.stringify(users); const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(s); a.download='backup.json'; a.click(); }
    function resetBalance(){ if(confirm("Hapus semua?")) { currentUser.pockets.forEach(p=>p.balance=0); currentUser.transactions=[]; updateUI(); alert("Reset!"); } }
    function toggleBalanceVisibility(){ isBalanceHidden=!isBalanceHidden; localStorage.setItem('balance_hidden', isBalanceHidden); updateUI(); }
    function setTheme(p,d){ document.documentElement.style.setProperty('--primary-color',p); document.documentElement.style.setProperty('--primary-dark',d); localStorage.setItem('theme_primary',p); localStorage.setItem('theme_dark',d); }
    function formatInputRupiah(e){ let v=e.value.replace(/\D/g,''); e.value=v?new Intl.NumberFormat('id-ID').format(v):''; }
</script>
</body>
</html>
